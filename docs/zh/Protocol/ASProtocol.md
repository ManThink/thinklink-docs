# 1. LoRaWAN NS åº”ç”¨å±‚æ¥å£åè®®
  è¯¥åè®®æè¿°äº† LoRaWANå°†æ•°æ®è§£å¯†åé€šè¿‡mqttè½¬å‘çš„åè®®æ ¼å¼ï¼Œå…¶ä¸­çš„payloadä¸ºè®¾å¤‡å‘é€çš„ç»LoRaWAN NSè§£å¯†åçš„æ•°æ®ã€‚
## 1.1. LoRaWAN NS çš„ä½œç”¨
LoRaWAN ç½‘ç»œæœåŠ¡å™¨(NS, Network Server)æ˜¯LoRaWANæ¶æ„ä¸­çš„æ ¸å¿ƒç»„ä»¶ï¼Œä¸»è¦è´Ÿè´£ä»¥ä¸‹åŠŸèƒ½ï¼š
+ ç®¡ç†ç»ˆç«¯è®¾å¤‡ä¸ç½‘å…³ä¹‹é—´çš„é€šä¿¡
+ å¤„ç†MACå±‚åè®®
+ å®ç°è‡ªé€‚åº”æ•°æ®é€Ÿç‡(ADR)æ§åˆ¶
+ ç®¡ç†è®¾å¤‡æ¿€æ´»å’Œå®‰å…¨è®¤è¯
+ æ•°æ®è·¯ç”±å’Œè½¬å‘
+ ä¸‹è¡Œæ•°æ®è°ƒåº¦

## 1.2. NSä¸åº”ç”¨æœåŠ¡å™¨çš„å…³ç³»
NSä¸åº”ç”¨æœåŠ¡å™¨(AS, Application Server)ä¹‹é—´é€šè¿‡MQTTåè®®è¿›è¡Œé€šä¿¡ï¼Œå®ç°ä»¥ä¸‹äº¤äº’ï¼š
+ NSå°†ç»ˆç«¯è®¾å¤‡çš„ä¸Šè¡Œæ•°æ®è½¬å‘ç»™AS
+ ASé€šè¿‡NSå‘ç»ˆç«¯è®¾å¤‡å‘é€ä¸‹è¡Œæ•°æ®
+ NSå‘ASæä¾›ç½‘ç»œçŠ¶æ€å’Œè®¾å¤‡çŠ¶æ€ä¿¡æ¯

é€šä¿¡ç‰¹ç‚¹ï¼š

+ é‡‡ç”¨MQTTåè®®ä½œä¸ºä¼ è¾“å±‚
+ æ¶ˆæ¯ä½“ä½¿ç”¨JSONæ ¼å¼
+ æ”¯æŒåŒå‘å¼‚æ­¥é€šä¿¡
+ åŸºäºä¸»é¢˜(Topic)çš„æ¶ˆæ¯è·¯ç”±

## 1.3. ä¸Šè¡Œæ•°æ®åè®®(Up Protocol)
### 1.3.1. æ¶ˆæ¯åˆ†ç±»
ä¸Šè¡Œæ¶ˆæ¯åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š

+ `data`: å¿«é€Ÿä¸Šè¡Œæ¶ˆæ¯(ç«‹å³è½¬å‘)
+ `dataAll`: å®Œæ•´ä¸Šè¡Œæ¶ˆæ¯(ç­‰å¾…å¤šç½‘å…³æ•°æ®æ”¶é›†)
+ `ack`: ä¸‹è¡Œç¡®è®¤æ¶ˆæ¯
+ `mac`: MACå±‚å‘½ä»¤æ¶ˆæ¯
+ `gw`: ç½‘å…³çŠ¶æ€æ¶ˆæ¯
+ `dataIP`: IPæ¥å£æ•°æ®æ¶ˆæ¯

### 1.3.2. åŸºæœ¬æ¶ˆæ¯æ ¼å¼
```json
{
  "version": "3.1",
  "moteeui": "3f53012a000050a9",
  "if": "loraWAN",
  "token": 135,
  "type": "data",
  "userdata": {
    "class": "ClassC",
    "confirmed": false,
    "seqno": 42158,
    "port": 3,
    "payload": "vV0="
  },
  "moteTx": {
    "freq": 471.7,
    "modu": "LORA",
    "datr": "SF12BW125",
   codr": "4/5"
  },
  "gwrx": [
    {
      "eui": "b100000000000128",
      "time": "",
      "tmms": 0,
      "tmst": 0,
      "ftime": 0,
      "chan": 7,
      "rfch": 1,
      "rssi": -43,
      "lsnr": 14.2
    }
  ],
  "geoInfo": {
    "longitude": 116.49325007243958,
    "latitude": 39.78473521213761,
    "altitude": 0,
    "accuracy": 50,
    "type": "gw:wifi"
  }
}
```

+ `version`: åè®®ç‰ˆæœ¬å·
+ `moteeui`: è®¾å¤‡å”¯ä¸€æ ‡è¯†(DevEUI)
+ `if`: æ¥å£ç±»å‹(loraWAN/can/485/mbusç­‰)
+ `token`: æ¶ˆæ¯åºåˆ—å·
+ `type`: æ¶ˆæ¯ç±»å‹
+ `userdata`: åº”ç”¨æ•°æ®
    - `class`: è®¾å¤‡å·¥ä½œæ¨¡å¼(ClassA/B/C)
    - `confirmed`: æ˜¯å¦ä¸ºç¡®è®¤æ¶ˆæ¯
    - `seqno`: ä¸Šè¡Œåºåˆ—å·
    - `port`: åº”ç”¨ç«¯å£
    - `payload`: Base64ç¼–ç çš„åº”ç”¨æ•°æ®
+ `moteTx`: æ— çº¿å‘å°„å‚æ•°
    - `freq`: é¢‘ç‚¹(MHz)
    - `modu`: è°ƒåˆ¶æ–¹å¼
    - `datr`: æ•°æ®é€Ÿç‡
    - `codr`: ç¼–ç ç‡
+ `gwrx`: ç½‘å…³æ¥æ”¶ä¿¡æ¯æ•°ç»„
    - `eui`: ç½‘å…³EUI
    - `time`: æ¥æ”¶æ—¶é—´
    - `tmms`: GPSåŒæ­¥æ—¶é—´æˆ³
    - `tmst`: ç›¸å¯¹æ—¶é—´æˆ³(Î¼s)
    - `ftime`: ç©ºä¸­é£è¡Œæ—¶é—´
    - `chan`: LoRaé€šé“ç¼–å·
    - `rfch`: LoRaé“¾è·¯ç¼–å·
    - `rssi`: æ¥æ”¶ä¿¡å·å¼ºåº¦(dBm)
    - `lsnr`: ä¿¡å™ªæ¯”(dB)
+ `geoInfo`: åœ°ç†ä½ç½®ä¿¡æ¯
    - `longitude`: ç»åº¦
    - `latitude`: çº¬åº¦
    - `altitude`: æµ·æ‹”
    - `accuracy`: ç²¾åº¦
    - `type`: ä½ç½®ä¿¡æ¯æ¥æº

### 1.3.3. ä¸Šè¡Œæ¶ˆæ¯ä¸»é¢˜(Topic)
| æ¶ˆæ¯ç±»å‹ | Topicæ ¼å¼ | æè¿° |
| --- | --- | --- |
| å¿«é€Ÿæ¶ˆæ¯ | `/v32/{tenant}/as/up/data/{deveui}` | NSæ”¶åˆ°æ•°æ®ç«‹å³è½¬å‘ï¼Œä¸ç­‰å¾…å¤šç½‘å…³æ•°æ®æ”¶é›† |
| å®Œæ•´æ¶ˆæ¯ | `/v32/{tenant}/as/up/dataAll/{deveui}` | NSç­‰å¾…å¤šç½‘å…³æ•°æ®æ”¶é›†å®Œæˆåè½¬å‘ |


+ `{tenant}`: ç»„ç»‡åç§°æ ‡è¯†
+ `{deveui}`: è®¾å¤‡EUI
+ ä¸¤ç§æ¶ˆæ¯çš„æ¶ˆæ¯ä½“æ ¼å¼ç›¸åŒï¼ŒåŒºåˆ«ä»…åœ¨äºè½¬å‘æ—¶æœºå’Œæ•°æ®å®Œæ•´æ€§

## 1.4. ä¸‹è¡Œæ•°æ®åè®®(Down Protocol)
### 1.4.1. åŸºæœ¬æ¶ˆæ¯æ ¼å¼
```json
{
  "version": "3.1",
  "type": "dataIP",
  "if": "485",
  "moteeui": "3f53012a00004081",
  "token": 1,
  "userdata": {
    "confirmed": false,
    "fpend": false,
    "port": 61,
    "payload": "gSQBAAAAdARQJ/sA",
    "specify": {
      "gweui": "",
      "txTime": ""
    }
  }
}
```

å­—æ®µè¯´æ˜ï¼š

+ `version`: åè®®ç‰ˆæœ¬å·
+ `type`: æ¶ˆæ¯ç±»å‹(data/dataIP/dataClear)
+ `if`: æ¥å£ç±»å‹
+ `moteeui`: è®¾å¤‡EUI
+ `token`: æ¶ˆæ¯åºåˆ—å·
+ `userdata`: åº”ç”¨æ•°æ®
    - `confirmed`: æ˜¯å¦ä¸ºç¡®è®¤æ¶ˆæ¯
    - `fpend`: æ˜¯å¦è¦æ±‚è®¾å¤‡å‘èµ·Pullæ•°æ®è¯·æ±‚
    - `port`: åº”ç”¨ç«¯å£(-1è¡¨ç¤ºMACæŒ‡ä»¤ï¼Œ0è¡¨ç¤ºPayload MACæŒ‡ä»¤ï¼Œ>0è¡¨ç¤ºæ­£å¸¸ç«¯å£)
    - `payload`: Base64ç¼–ç çš„ä¸‹è¡Œæ•°æ®
    - `specify`: ç‰¹æ®Šå‚æ•°
        * `gweui`: æŒ‡å®šå‘é€ç½‘å…³(ä¸ºç©ºè¡¨ç¤ºä¸æŒ‡å®š)
        * `txTime`: ä¿ç•™å­—æ®µ

### 1.4.2. ä¸‹è¡Œç¡®è®¤æ¶ˆæ¯
#### 1.4.2.1. Topicæ ¼å¼
`/v32/{tenant}/as/up/ack/{deveui}`

##### 1.4.2.1.1. æ¶ˆæ¯å†…å®¹
```json
{
  "version": "3.1",
  "type": "ackSeq",
  "moteeui": "3f53012a00004081",
  "token": 1,
  "msg": "OK",
  "seq": 83257
}
```

å­—æ®µè¯´æ˜ï¼š

+ `type`: ç¡®è®¤ç±»å‹(ackSeq/ackTx)
    - `ackSeq`: å“åº”å¸§å·(è¡¨ç¤ºNSå·²æ¥æ”¶ä¸‹è¡Œæ•°æ®)
    - `ackTx`: å‘é€å“åº”(è¡¨ç¤ºæ•°æ®å·²å‘é€åˆ°è®¾å¤‡)
+ `token`: å¯¹åº”åŸå§‹ä¸‹è¡Œæ¶ˆæ¯çš„token
+ `msg`: çŠ¶æ€ä¿¡æ¯("OK"è¡¨ç¤ºæˆåŠŸï¼Œå…¶ä»–ä¸ºå¤±è´¥åŸå› )
+ `seq`: NSåˆ†é…çš„ä¸‹è¡Œåºåˆ—å·(å¤±è´¥æ—¶ä¸º-1)

ç¡®è®¤æµç¨‹ï¼š

1. å¯¹äºLoRaWANè®¾å¤‡ï¼š
    - ç¬¬ä¸€åŒ…ç¡®è®¤(ackSeq): NSæ¥æ”¶ä¸‹è¡Œæ•°æ®ååé¦ˆ
    - ç¬¬äºŒåŒ…ç¡®è®¤(ackTx): æ•°æ®å‘é€åˆ°è®¾å¤‡ååé¦ˆ
2. å¯¹äºIP DTUè®¾å¤‡ï¼š
    - ç¬¬ä¸€åŒ…ç¡®è®¤(ackSeq): æ•°æ®å‘é€ååé¦ˆ
    - ç¬¬äºŒåŒ…ç¡®è®¤(ackTx): ä»…åœ¨æœ‰timeoutäº‹ä»¶æ—¶åé¦ˆ

### 1.4.3. ä¸‹è¡Œæ¶ˆæ¯ä¸»é¢˜(Topic)
| Topicæ ¼å¼ | è®¢é˜…è€… | å‘é€è€… | æè¿° |
| --- | --- | --- | --- |
| `/v32/{tenant}/as/dn/data/{deveui}` | NS | åº”ç”¨æœåŠ¡å™¨ | åº”ç”¨æœåŠ¡å™¨å‘NSå‘é€ä¸‹è¡Œæ•°æ® |


#### 1.4.3.1. ä¸‹è¡Œæ•°æ®ç¤ºä¾‹
```json
{
  "version": "3.1",
  "moteeui": "34010134112b8001",
  "type": "data",
  "if": "loraWAN",
  "token": 1,
  "userdata": {
    "confirmed": false,
    "fpend": false,
    "port": 61,
    "payload": "gSQBAAAAdARQJ/sA",
    "intervalms": 0,
    "dnWaitms": 0,
    "specify": {
      "gweui": "",
      "txTime": ""
    }
  }
}
```

#### 1.4.3.2. ä¸‹è¡Œæ¸…é™¤ç¼“å­˜ç¤ºä¾‹
```json
{
  "version": "3.1",
  "moteeui": "34010134112b8001",
  "type": "dataClear",
  "if": "loraWAN",
  "token": 1,
  "userdata": {
    "confirmed": false,
    "fpend": false,
    "port": 61,
    "payload": "gSQBAAAAdARQJ/sA",
    "intervalms": 0,
    "dnWaitms": 0,
    "specify": {
      "gweui": "",
      "txTime": ""
    }
  }
}
```

1. `type=dataClear`: åœ¨å‘é€ä¸‹è¡Œæ•°æ®çš„åŒæ—¶æ¸…é™¤NSç¼“å­˜ä¸­çš„å¾…å‘æ•°æ®ï¼Œ
2. `intervalms`: åŒè®¾å¤‡é—´çš„ä¸‹è¡Œç­‰å¾…é—´éš”(ms)ï¼Œ0è¡¨ç¤ºä¸ç­‰å¾…
3. `dnWaitms`: ä¸‹è¡Œç­‰å¾…é—´éš”(ms)ï¼ŒNS ç­‰å¾… dnWaitms ç§’åæ²¡æœ‰å›å¤åˆ™å›å¤ç»™AS æ­¤åŒ…æ•°æ®å‘é€å¤±è´¥ã€‚
4. `specify.gweui`: éç©ºæ—¶æŒ‡å®šç‰¹å®šç½‘å…³å‘é€æ•°æ®

ğŸŒ å®˜ç½‘ï¼š[www.manthink.cn](http://www.manthink.cn)  
âœ‰  æŠ€æœ¯æ”¯æŒé‚®ç®±ï¼šinfo@manthink.cn  
â˜  ç´§æ€¥è”ç³»ç”µè¯ï¼š+86-15810684257

